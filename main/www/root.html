<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
</head>
<body style='background-color: #EEEEEE;'>

<span style='color: #003366;'>

<h1>Lets generate a random number</h1>
<p><label>Auto send init-request?</label>
  <input type="checkbox" id="INP_AUTOINIT" checked></input</p>
<p><button type='button' id='BTN_INIT'>
  Init connection to ESP32</button>
  <button type='button' id='BTN_SEND_INIT_REQ' style="display: none">
    Send Init-Request to ESP32</button>
</p>

</span>

</body>
<script>
  // Example controller details
  const display_name = "test";
  const type = 5054;
  const mac_address = "5-3-5-4";

  var Socket;
  document.getElementById('BTN_INIT').addEventListener('click', button_init);
  document.getElementById('BTN_SEND_INIT_REQ').addEventListener('click', button_send_init_req);
  document.getElementById('INP_AUTOINIT').addEventListener('change', toggle_auto_send);

  function button_init() {
    Socket = new WebSocket("wss://devcon.growcontrol.de:4191/");
    console.log("opened " + Socket);
    Socket.onmessage = function(event) {
      console.log("got message: ", event.data)
    };
    Socket.onclose = function(event) {
      console.log("closed");
    }
    if (document.getElementById("INP_AUTOINIT").checked)
      Socket.onopen(button_send_init_req());
  }
  function button_send_init_req() {
    var req = { 
      command: 'mock_initialize', 
      cookie: document.cookie, 
      internal_id: display_name.toLowerCase().replace(' ', '_'),
      data: {}
    };
    req.data['display_name'] = display_name;
    req.data['type'] = type;
    req.data['mac_address'] = mac_address;
    req.data['version'] = '#latest';
    
    const json_str = JSON.stringify(req);
    // SEND AS JSON: 
    //Socket.send();
    // SEND AS BINARY
    const binary_str = toBinary(json_str);
    // Convert to unit8 array
    let binaryData = new Uint8Array(
      atob(binary_str)
        .split('')
        .map(function (c) {
          return c.charCodeAt(0);
        })
    );
    // Finally send data
    socket.send(binaryData);
  }
  function toggle_auto_send() {
    var btn = document.getElementById("BTN_SEND_INIT_REQ")
    btn.style.display = (btn.style.display === "none") ? "block" : "none";
  }
</script>
</html>
